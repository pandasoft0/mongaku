"use strict";

var url = require("url");

var mongoosastic = require("mongoosastic");
var versioner = require("mongoose-version");

var db = require("./db");
var config = require("./config");
var options = require("./options");
var metadata = require("./metadata");

var records = {};

module.exports = function (type) {
    if (records[type]) {
        return records[type];
    }

    var typeInfo = options.types[type];

    if (!typeInfo) {
        throw new Error("Type not found: " + type);
    }

    var Record = require("../schemas/Record");
    var modelProps = metadata.schemas(type);
    var schemaProps = Object.assign({}, Record.schema, modelProps);

    if (typeInfo.urlRequired) {
        schemaProps.url = Object.assign({ required: true }, schemaProps.url);
    }

    if (typeInfo.noImages) {
        schemaProps.images = Object.assign({ required: false }, schemaProps.images);
        schemaProps.defaultImageHash = Object.assign({ required: false }, schemaProps.defaultImageHash);
    } else if (typeInfo.imagesRequired) {
        schemaProps.images = Object.assign({ required: true }, schemaProps.images);
        schemaProps.defaultImageHash = Object.assign({ required: true }, schemaProps.defaultImageHash);
    } else {
        schemaProps.images = Object.assign({ recommended: true }, schemaProps.images);
        schemaProps.defaultImageHash = Object.assign({ recommended: true }, schemaProps.defaultImageHash);
    }

    var Schema = new db.schema(schemaProps, {
        collection: type
    });

    Schema.methods = Record.methods;
    Schema.statics = Object.assign({
        getType: function getType() {
            return type;
        }
    }, Record.statics);

    var es = url.parse(config.ELASTICSEARCH_URL);

    Schema.plugin(mongoosastic, {
        index: type,
        type: type,
        host: es.hostname,
        auth: es.auth,
        port: es.port,
        // Trim the trailing ":" from the protocol
        protocol: es.protocol.slice(0, -1)
    });

    Schema.plugin(versioner, {
        collection: type + "_versions",
        suppressVersionIncrement: false,
        suppressRefIdIndex: false,
        refIdType: String,
        removeVersions: false,
        strategy: "collection",
        mongoose: db.mongoose
    });

    // Dynamically generate the _id attribute
    Schema.pre("validate", function (next) {
        if (!this._id) {
            this._id = this.source + "/" + this.id;
        }
        next();
    });

    /* istanbul ignore next */
    Schema.pre("save", function (next) {
        // Always updated the modified time on every save
        this.modified = new Date();
        next();
    });

    records[type] = db.model(type, Schema);

    return records[type];
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvcmVjb3JkLmpzIl0sIm5hbWVzIjpbInVybCIsInJlcXVpcmUiLCJtb25nb29zYXN0aWMiLCJ2ZXJzaW9uZXIiLCJkYiIsImNvbmZpZyIsIm9wdGlvbnMiLCJtZXRhZGF0YSIsInJlY29yZHMiLCJtb2R1bGUiLCJleHBvcnRzIiwidHlwZSIsInR5cGVJbmZvIiwidHlwZXMiLCJFcnJvciIsIlJlY29yZCIsIm1vZGVsUHJvcHMiLCJzY2hlbWFzIiwic2NoZW1hUHJvcHMiLCJPYmplY3QiLCJhc3NpZ24iLCJzY2hlbWEiLCJ1cmxSZXF1aXJlZCIsInJlcXVpcmVkIiwibm9JbWFnZXMiLCJpbWFnZXMiLCJkZWZhdWx0SW1hZ2VIYXNoIiwiaW1hZ2VzUmVxdWlyZWQiLCJyZWNvbW1lbmRlZCIsIlNjaGVtYSIsImNvbGxlY3Rpb24iLCJtZXRob2RzIiwic3RhdGljcyIsImdldFR5cGUiLCJlcyIsInBhcnNlIiwiRUxBU1RJQ1NFQVJDSF9VUkwiLCJwbHVnaW4iLCJpbmRleCIsImhvc3QiLCJob3N0bmFtZSIsImF1dGgiLCJwb3J0IiwicHJvdG9jb2wiLCJzbGljZSIsInN1cHByZXNzVmVyc2lvbkluY3JlbWVudCIsInN1cHByZXNzUmVmSWRJbmRleCIsInJlZklkVHlwZSIsIlN0cmluZyIsInJlbW92ZVZlcnNpb25zIiwic3RyYXRlZ3kiLCJtb25nb29zZSIsInByZSIsIm5leHQiLCJfaWQiLCJzb3VyY2UiLCJpZCIsIm1vZGlmaWVkIiwiRGF0ZSIsIm1vZGVsIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQU1BLE1BQU1DLFFBQVEsS0FBUixDQUFaOztBQUVBLElBQU1DLGVBQWVELFFBQVEsY0FBUixDQUFyQjtBQUNBLElBQU1FLFlBQVlGLFFBQVEsa0JBQVIsQ0FBbEI7O0FBRUEsSUFBTUcsS0FBS0gsUUFBUSxNQUFSLENBQVg7QUFDQSxJQUFNSSxTQUFTSixRQUFRLFVBQVIsQ0FBZjtBQUNBLElBQU1LLFVBQVVMLFFBQVEsV0FBUixDQUFo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QyxtQkFBV0MsTUFKVTtBQUtyQkMsd0JBQWdCLEtBTEs7QUFNckJDLGtCQUFVLFlBTlc7QUFPckJDLGtCQUFVL0MsR0FBRytDO0FBUFEsS0FBekI7O0FBVUE7QUFDQXRCLFdBQU91QixHQUFQLENBQVcsVUFBWCxFQUF1QixVQUFTQyxJQUFULEVBQWU7QUFDbEMsWUFBSSxDQUFDLEtBQUtDLEdBQVYsRUFBZTtBQUNYLGlCQUFLQSxHQUFMLEdBQWMsS0FBS0MsTUFBbkIsU0FBNkIsS0FBS0MsRUFBbEM7QUFDSDtBQUNESDtBQUNILEtBTEQ7O0FBT0E7QUFDQXhCLFdBQU91QixHQUFQLENBQVcsTUFBWCxFQUFtQixVQUFTQyxJQUFULEVBQWU7QUFDOUI7QUFDQSxhQUFLSSxRQUFMLEdBQWdCLElBQUlDLElBQUosRUFBaEI7QUFDQUw7QUFDSCxLQUpEOztBQU1BN0MsWUFBUUcsSUFBUixJQUFnQlAsR0FBR3VELEtBQUgsQ0FBU2hELElBQVQsRUFBZWtCLE1BQWYsQ0FBaEI7O0FBRUEsV0FBT3JCLFFBQVFHLElBQVIsQ0FBUDtBQUNILENBckZEIiwiZmlsZSI6InJlY29yZC5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHVybCA9IHJlcXVpcmUoXCJ1cmxcIik7XG5cbmNvbnN0IG1vbmdvb3Nhc3RpYyA9IHJlcXVpcmUoXCJtb25nb29zYXN0aWNcIik7XG5jb25zdCB2ZXJzaW9uZXIgPSByZXF1aXJlKFwibW9uZ29vc2UtdmVyc2lvblwiKTtcblxuY29uc3QgZGIgPSByZXF1aXJlKFwiLi9kYlwiKTtcbmNvbnN0IGNvbmZpZyA9IHJlcXVpcmUoXCIuL2NvbmZpZ1wiKTtcbmNvbnN0IG9wdGlvbnMgPSByZXF1aXJlKFwiLi9vcHRpb25zXCIpO1xuY29uc3QgbWV0YWRhdGEgPSByZXF1aXJlKFwiLi9tZXRhZGF0YVwiKTtcblxuY29uc3QgcmVjb3JkcyA9IHt9O1xuXG5tb2R1bGUuZXhwb3J0cyA9ICh0eXBlKSA9PiB7XG4gICAgaWYgKHJlY29yZHNbdHlwZV0pIHtcbiAgICAgICAgcmV0dXJuIHJlY29yZHNbdHlwZV07XG4gICAgfVxuXG4gICAgY29uc3QgdHlwZUluZm8gPSBvcHRpb25zLnR5cGVzW3R5cGVdO1xuXG4gICAgaWYgKCF0eXBlSW5mbykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFR5cGUgbm90IGZvdW5kOiAke3R5cGV9YCk7XG4gICAgfVxuXG4gICAgY29uc3QgUmVjb3JkID0gcmVxdWlyZShcIi4uL3NjaGVtYXMvUmVjb3JkXCIpO1xuICAgIGNvbnN0IG1vZGVsUHJvcHMgPSBtZXRhZGF0YS5zY2hlbWFzKHR5cGUpO1xuICAgIGNvbnN0IHNjaGVtYVByb3BzID0gT2JqZWN0LmFzc2lnbih7fSwgUmVjb3JkLnNjaGVtYSwgbW9kZWxQcm9wcyk7XG5cbiAgICBpZiAodHlwZUluZm8udXJsUmVxdWlyZWQpIHtcbiAgICAgICAgc2NoZW1hUHJvcHMudXJsID0gT2JqZWN0LmFzc2lnbih7cmVxdWlyZWQ6IHRydWV9LCBzY2hlbWFQcm9wcy51cmwpO1xuICAgIH1cblxuICAgIGlmICh0eXBlSW5mby5ub0ltYWdlcykge1xuICAgICAgICBzY2hlbWFQcm9wcy5pbWFnZXMgPSBPYmplY3QuYXNzaWduKHtyZXF1aXJlZDogZmFsc2V9LFxuICAgICAgICAgICAgc2NoZW1hUHJvcHMuaW1hZ2VzKTtcbiAgICAgICAgc2NoZW1hUHJvcHMuZGVmYXVsdEltYWdlSGFzaCA9IE9iamVjdC5hc3NpZ24oe3JlcXVpcmVkOiBmYWxzZX0sXG4gICAgICAgICAgICBzY2hlbWFQcm9wcy5kZWZhdWx0SW1hZ2VIYXNoKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVJbmZvLmltYWdlc1JlcXVpcmVkKSB7XG4gICAgICAgIHNjaGVtYVByb3BzLmltYWdlcyA9IE9iamVjdC5hc3NpZ24oe3JlcXVpcmVkOiB0cnVlfSxcbiAgICAgICAgICAgIHNjaGVtYVByb3BzLmltYWdlcyk7XG4gICAgICAgIHNjaGVtYVByb3BzLmRlZmF1bHRJbWFnZUhhc2ggPSBPYmplY3QuYXNzaWduKHtyZXF1aXJlZDogdHJ1ZX0sXG4gICAgICAgICAgICBzY2hlbWFQcm9wcy5kZWZhdWx0SW1hZ2VIYXNoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBzY2hlbWFQcm9wcy5pbWFnZXMgPSBPYmplY3QuYXNzaWduKHtyZWNvbW1lbmRlZDogdHJ1ZX0sXG4gICAgICAgICAgICBzY2hlbWFQcm9wcy5pbWFnZXMpO1xuICAgICAgICBzY2hlbWFQcm9wcy5kZWZhdWx0SW1hZ2VIYXNoID0gT2JqZWN0LmFzc2lnbih7cmVjb21tZW5kZWQ6IHRydWV9LFxuICAgICAgICAgICAgc2NoZW1hUHJvcHMuZGVmYXVsdEltYWdlSGFzaCk7XG4gICAgfVxuXG4gICAgY29uc3QgU2NoZW1hID0gbmV3IGRiLnNjaGVtYShzY2hlbWFQcm9wcywge1xuICAgICAgICBjb2xsZWN0aW9uOiB0eXBlLFxuICAgIH0pO1xuXG4gICAgU2NoZW1hLm1ldGhvZHMgPSBSZWNvcmQubWV0aG9kcztcbiAgICBTY2hlbWEuc3RhdGljcyA9IE9iamVjdC5hc3NpZ24oe1xuICAgICAgICBnZXRUeXBlOiAoKSA9PiB0eXBlLFxuICAgIH0sIFJlY29yZC5zdGF0aWNzKTtcblxuICAgIGNvbnN0IGVzID0gdXJsLnBhcnNlKGNvbmZpZy5FTEFTVElDU0VBUkNIX1VSTCk7XG5cbiAgICBTY2hlbWEucGx1Z2luKG1vbmdvb3Nhc3RpYywge1xuICAgICAgICBpbmRleDogdHlwZSxcbiAgICAgICAgdHlwZSxcbiAgICAgICAgaG9zdDogZXMuaG9zdG5hbWUsXG4gICAgICAgIGF1dGg6IGVzLmF1dGgsXG4gICAgICAgIHBvcnQ6IGVzLnBvcnQsXG4gICAgICAgIC8vIFRyaW0gdGhlIHRyYWlsaW5nIFwiOlwiIGZyb20gdGhlIHByb3RvY29sXG4gICAgICAgIHByb3RvY29sOiBlcy5wcm90b2NvbC5zbGljZSgwLCAtMSksXG4gICAgfSk7XG5cbiAgICBTY2hlbWEucGx1Z2luKHZlcnNpb25lciwge1xuICAgICAgICBjb2xsZWN0aW9uOiBgJHt0eXBlfV92ZXJzaW9uc2AsXG4gICAgICAgIHN1cHByZXNzVmVyc2lvbkluY3JlbWVudDogZmFsc2UsXG4gICAgICAgIHN1cHByZXNzUmVmSWRJbmRleDogZmFsc2UsXG4gICAgICAgIHJlZklkVHlwZTogU3RyaW5nLFxuICAgICAgICByZW1vdmVWZXJzaW9uczogZmFsc2UsXG4gICAgICAgIHN0cmF0ZWd5OiBcImNvbGxlY3Rpb25cIixcbiAgICAgICAgbW9uZ29vc2U6IGRiLm1vbmdvb3NlLFxuICAgIH0pO1xuXG4gICAgLy8gRHluYW1pY2FsbHkgZ2VuZXJhdGUgdGhlIF9pZCBhdHRyaWJ1dGVcbiAgICBTY2hlbWEucHJlKFwidmFsaWRhdGVcIiwgZnVuY3Rpb24obmV4dCkge1xuICAgICAgICBpZiAoIXRoaXMuX2lkKSB7XG4gICAgICAgICAgICB0aGlzLl9pZCA9IGAke3RoaXMuc291cmNlfS8ke3RoaXMuaWR9YDtcbiAgICAgICAgfVxuICAgICAgICBuZXh0KCk7XG4gICAgfSk7XG5cbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgIFNjaGVtYS5wcmUoXCJzYXZlXCIsIGZ1bmN0aW9uKG5leHQpIHtcbiAgICAgICAgLy8gQWx3YXlzIHVwZGF0ZWQgdGhlIG1vZGlmaWVkIHRpbWUgb24gZXZlcnkgc2F2ZVxuICAgICAgICB0aGlzLm1vZGlmaWVkID0gbmV3IERhdGUoKTtcbiAgICAgICAgbmV4dCgpO1xuICAgIH0pO1xuXG4gICAgcmVjb3Jkc1t0eXBlXSA9IGRiLm1vZGVsKHR5cGUsIFNjaGVtYSk7XG5cbiAgICByZXR1cm4gcmVjb3Jkc1t0eXBlXTtcbn07XG4iXX0=
"use strict";

var path = require("path");

var tap = require("tap");

var init = require("../init");
var UploadImage = init.UploadImage;

tap.test("getFilePath", { autoend: true }, function (t) {
    var image = init.getUploadImage();
    t.equal(image.getFilePath(), path.resolve(process.cwd(), "data/uploads/images/4266906334.jpg"), "Check file path");
});

tap.test("getOriginalURL", { autoend: true }, function (t) {
    var image = init.getUploadImage();
    t.equal(image.getOriginalURL(), "/data/uploads/images/4266906334.jpg", "Check UploadImage URL");
});

tap.test("getScaledURL", { autoend: true }, function (t) {
    var image = init.getUploadImage();
    t.equal(image.getScaledURL(), "/data/uploads/scaled/4266906334.jpg", "Check Scaled URL");
});

tap.test("getThumbURL", { autoend: true }, function (t) {
    var image = init.getUploadImage();
    t.equal(image.getThumbURL(), "/data/uploads/thumbs/4266906334.jpg", "Check Thumb URL");
});

tap.test("updateSimilarity: New UploadImage", function (t) {
    var image = new UploadImage({
        _id: "uploads/614431508.jpg",
        source: "uploads",
        fileName: "614431508.jpg",
        hash: "614431508",
        width: 100,
        height: 100
    });

    var oldSimilar = image.similarImages;
    image.updateSimilarity(function (err) {
        t.error(err, "No error should be thrown.");
        t.notEqual(image.similarImages, oldSimilar, "Similarity updated.");
        t.equal(image.similarImages.length, 1, "Has the correct number of results.");
        t.same(image.similarImages[0].toJSON(), { _id: "test/bar.jpg", score: 9 }, "Has the correct result.");
        t.end();
    });
});

tap.test("updateSimilarity: Existing UploadImage", function (t) {
    var image = init.getUploadImage();
    var oldSimilar = image.similarImages;
    image.updateSimilarity(function (err) {
        t.error(err, "No error should be thrown.");
        t.notEqual(image.similarImages, oldSimilar, "Similarity updated.");
        t.equal(image.similarImages.length, 1, "Has the correct number of results.");
        t.same(image.similarImages[0].toJSON(), { _id: "test/bar.jpg", score: 10 }, "Has the correct result.");
        t.end();
    });
});

tap.test("UploadImage.fromFile: New UploadImage", function (t) {
    var testFile = path.resolve(process.cwd(), "testData", "new1.jpg");

    UploadImage.fromFile(testFile, function (err, image) {
        t.error(err, "No error should be thrown.");
        t.ok(image, "UploadImage exists.");
        // TODO: Test that files exist.
        // Test that files are the right dimensions.
        t.end();
    });
});

tap.test("UploadImage.fromFile: New UploadImage (Empty File)", function (t) {
    var testFile = path.resolve(process.cwd(), "testData", "empty.jpg");

    UploadImage.fromFile(testFile, function (err, image) {
        t.ok(err, "Has error object.");
        t.equal(err.message, "EMPTY_IMAGE", "Has error message.");
        t.notOk(image, "No image object");
        t.end();
    });
});

tap.test("UploadImage.fromFile: New UploadImage (Corrupted File)", function (t) {
    var testFile = path.resolve(process.cwd(), "testData", "corrupted.jpg");

    UploadImage.fromFile(testFile, function (err, image) {
        t.ok(err, "Has error object.");
        t.equal(err.message, "MALFORMED_IMAGE", "Has error message.");
        t.notOk(image, "No image object");
        t.end();
    });
});

tap.test("UploadImage.fromFile: New UploadImage (Small File)", function (t) {
    var testFile = path.resolve(process.cwd(), "testData", "small.jpg");

    UploadImage.fromFile(testFile, function (err, image) {
        t.ok(err, "Has error object.");
        t.equal(err.message, "TOO_SMALL", "Has error message.");
        t.notOk(image, "No image object");
        t.end();
    });
});

tap.test("UploadImage.fromFile: Updating UploadImage", function (t) {
    var testFile = path.resolve(process.cwd(), "testData", "foo.jpg");

    UploadImage.fromFile(testFile, function (err, image) {
        t.error(err, "No error should be thrown.");
        t.ok(image, "UploadImage exists.");
        t.end();
    });
});

tap.test("UploadImage.fromFile: Updating (files already exist)", function (t) {
    var testFile = path.resolve(process.cwd(), "testData", "foo.jpg");

    UploadImage.fromFile(testFile, function () {
        // Run this twice to have the images be put into place already
        UploadImage.fromFile(testFile, function (err, image) {
            t.error(err, "No error should be thrown.");
            t.ok(image, "UploadImage exists.");
            t.end();
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90ZXN0cy9zY2hlbWFzL1VwbG9hZEltYWdlLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwidGFwIiwiaW5pdCIsIlVwbG9hZEltYWdlIiwidGVzdCIsImF1dG9lbmQiLCJ0IiwiaW1hZ2UiLCJnZXRVcGxvYWRJbWFnZSIsImVxdWFsIiwiZ2V0RmlsZVBhdGgiLCJyZXNvbHZlIiwicHJvY2VzcyIsImN3ZCIsImdldE9yaWdpbmFsVVJMIiwiZ2V0U2NhbGVkVVJMIiwiZ2V0VGh1bWJVUkwiLCJfaWQiLCJzb3VyY2UiLCJmaWxlTmFtZSIsImhhc2giLCJ3aWR0aCIsImhlaWdodCIsIm9sZFNpbWlsYXIiLCJzaW1pbGFySW1hZ2VzIiwidXBkYXRlU2ltaWxhcml0eSIsImVyciIsImVycm9yIiwibm90RXF1YWwiLCJsZW5ndGgiLCJzYW1lIiwidG9KU09OIiwic2NvcmUiLCJlbmQiLCJ0ZXN0RmlsZSIsImZyb21GaWxlIiwib2siLCJtZXNzYWdlIiwibm90T2siXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsT0FBT0MsUUFBUSxNQUFSLENBQWI7O0FBRUEsSUFBTUMsTUFBTUQsUUFBUSxLQUFSLENBQVo7O0FBRUEsSUFBTUUsT0FBT0YsUUFBUSxTQUFSLENBQWI7QUFDQSxJQUFNRyxjQUFjRCxLQUFLQyxXQUF6Qjs7QUFFQUYsSUFBSUcsSUFBSixDQUFTLGFBQVQsRUFBd0IsRUFBQ0MsU0FBUyxJQUFWLEVBQXhCLEVBQXlDLFVBQUNDLENBQUQsRUFBTztBQUM1QyxRQUFNQyxRQUFRTCxLQUFLTSxjQUFMLEVBQWQ7QUFDQUYsTUFBRUcsS0FBRixDQUFRRixNQUFNRyxXQUFOLEVBQVIsRUFDSVgsS0FBS1ksT0FBTCxDQUFhQyxRQUFRQyxHQUFSLEVBQWIsRUFBNEIsb0NBQTVCLENBREosRUFFSSxpQkFGSjtBQUdILENBTEQ7O0FBT0FaLElBQUlHLElBQUosQ0FBUyxnQkFBVCxFQUEyQixFQUFDQyxTQUFTLElBQVYsRUFBM0IsRUFB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WUFBTTtBQUNqQztBQUNBL0Isb0JBQVlnQyxRQUFaLENBQXFCRCxRQUFyQixFQUErQixVQUFDUixHQUFELEVBQU1uQixLQUFOLEVBQWdCO0FBQzNDRCxjQUFFcUIsS0FBRixDQUFRRCxHQUFSLEVBQWEsNEJBQWI7QUFDQXBCLGNBQUU4QixFQUFGLENBQUs3QixLQUFMLEVBQVkscUJBQVo7QUFDQUQsY0FBRTJCLEdBQUY7QUFDSCxTQUpEO0FBS0gsS0FQRDtBQVFILENBWEQiLCJmaWxlIjoiVXBsb2FkSW1hZ2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5cbmNvbnN0IHRhcCA9IHJlcXVpcmUoXCJ0YXBcIik7XG5cbmNvbnN0IGluaXQgPSByZXF1aXJlKFwiLi4vaW5pdFwiKTtcbmNvbnN0IFVwbG9hZEltYWdlID0gaW5pdC5VcGxvYWRJbWFnZTtcblxudGFwLnRlc3QoXCJnZXRGaWxlUGF0aFwiLCB7YXV0b2VuZDogdHJ1ZX0sICh0KSA9PiB7XG4gICAgY29uc3QgaW1hZ2UgPSBpbml0LmdldFVwbG9hZEltYWdlKCk7XG4gICAgdC5lcXVhbChpbWFnZS5nZXRGaWxlUGF0aCgpLFxuICAgICAgICBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgXCJkYXRhL3VwbG9hZHMvaW1hZ2VzLzQyNjY5MDYzMzQuanBnXCIpLFxuICAgICAgICBcIkNoZWNrIGZpbGUgcGF0aFwiKTtcbn0pO1xuXG50YXAudGVzdChcImdldE9yaWdpbmFsVVJMXCIsIHthdXRvZW5kOiB0cnVlfSwgKHQpID0+IHtcbiAgICBjb25zdCBpbWFnZSA9IGluaXQuZ2V0VXBsb2FkSW1hZ2UoKTtcbiAgICB0LmVxdWFsKGltYWdlLmdldE9yaWdpbmFsVVJMKCksXG4gICAgICAgIFwiL2RhdGEvdXBsb2Fkcy9pbWFnZXMvNDI2NjkwNjMzNC5qcGdcIixcbiAgICAgICAgXCJDaGVjayBVcGxvYWRJbWFnZSBVUkxcIik7XG59KTtcblxudGFwLnRlc3QoXCJnZXRTY2FsZWRVUkxcIiwge2F1dG9lbmQ6IHRydWV9LCAodCkgPT4ge1xuICAgIGNvbnN0IGltYWdlID0gaW5pdC5nZXRVcGxvYWRJbWFnZSgpO1xuICAgIHQuZXF1YWwoaW1hZ2UuZ2V0U2NhbGVkVVJMKCksXG4gICAgICAgIFwiL2RhdGEvdXBsb2Fkcy9zY2FsZWQvNDI2NjkwNjMzNC5qcGdcIixcbiAgICAgICAgXCJDaGVjayBTY2FsZWQgVVJMXCIpO1xufSk7XG5cbnRhcC50ZXN0KFwiZ2V0VGh1bWJVUkxcIiwge2F1dG9lbmQ6IHRydWV9LCAodCkgPT4ge1xuICAgIGNvbnN0IGltYWdlID0gaW5pdC5nZXRVcGxvYWRJbWFnZSgpO1xuICAgIHQuZXF1YWwoaW1hZ2UuZ2V0VGh1bWJVUkwoKSxcbiAgICAgICAgXCIvZGF0YS91cGxvYWRzL3RodW1icy80MjY2OTA2MzM0LmpwZ1wiLFxuICAgICAgICBcIkNoZWNrIFRodW1iIFVSTFwiKTtcbn0pO1xuXG50YXAudGVzdChcInVwZGF0ZVNpbWlsYXJpdHk6IE5ldyBVcGxvYWRJbWFnZVwiLCAodCkgPT4ge1xuICAgIGNvbnN0IGltYWdlID0gbmV3IFVwbG9hZEltYWdlKHtcbiAgICAgICAgX2lkOiBcInVwbG9hZHMvNjE0NDMxNTA4LmpwZ1wiLFxuICAgICAgICBzb3VyY2U6IFwidXBsb2Fkc1wiLFxuICAgICAgICBmaWxlTmFtZTogXCI2MTQ0MzE1MDguanBnXCIsXG4gICAgICAgIGhhc2g6IFwiNjE0NDMxNTA4XCIsXG4gICAgICAgIHdpZHRoOiAxMDAsXG4gICAgICAgIGhlaWdodDogMTAwLFxuICAgIH0pO1xuXG4gICAgY29uc3Qgb2xkU2ltaWxhciA9IGltYWdlLnNpbWlsYXJJbWFnZXM7XG4gICAgaW1hZ2UudXBkYXRlU2ltaWxhcml0eSgoZXJyKSA9PiB7XG4gICAgICAgIHQuZXJyb3IoZXJyLCBcIk5vIGVycm9yIHNob3VsZCBiZSB0aHJvd24uXCIpO1xuICAgICAgICB0Lm5vdEVxdWFsKGltYWdlLnNpbWlsYXJJbWFnZXMsIG9sZFNpbWlsYXIsXG4gICAgICAgICAgICBcIlNpbWlsYXJpdHkgdXBkYXRlZC5cIik7XG4gICAgICAgIHQuZXF1YWwoaW1hZ2Uuc2ltaWxhckltYWdlcy5sZW5ndGgsIDEsXG4gICAgICAgICAgICBcIkhhcyB0aGUgY29ycmVjdCBudW1iZXIgb2YgcmVzdWx0cy5cIik7XG4gICAgICAgIHQuc2FtZShpbWFnZS5zaW1pbGFySW1hZ2VzWzBdLnRvSlNPTigpLFxuICAgICAgICAgICAge19pZDogXCJ0ZXN0L2Jhci5qcGdcIiwgc2NvcmU6IDl9LFxuICAgICAgICAgICAgXCJIYXMgdGhlIGNvcnJlY3QgcmVzdWx0LlwiKTtcbiAgICAgICAgdC5lbmQoKTtcbiAgICB9KTtcbn0pO1xuXG50YXAudGVzdChcInVwZGF0ZVNpbWlsYXJpdHk6IEV4aXN0aW5nIFVwbG9hZEltYWdlXCIsICh0KSA9PiB7XG4gICAgY29uc3QgaW1hZ2UgPSBpbml0LmdldFVwbG9hZEltYWdlKCk7XG4gICAgY29uc3Qgb2xkU2ltaWxhciA9IGltYWdlLnNpbWlsYXJJbWFnZXM7XG4gICAgaW1hZ2UudXBkYXRlU2ltaWxhcml0eSgoZXJyKSA9PiB7XG4gICAgICAgIHQuZXJyb3IoZXJyLCBcIk5vIGVycm9yIHNob3VsZCBiZSB0aHJvd24uXCIpO1xuICAgICAgICB0Lm5vdEVxdWFsKGltYWdlLnNpbWlsYXJJbWFnZXMsIG9sZFNpbWlsYXIsXG4gICAgICAgICAgICBcIlNpbWlsYXJpdHkgdXBkYXRlZC5cIik7XG4gICAgICAgIHQuZXF1YWwoaW1hZ2Uuc2ltaWxhckltYWdlcy5sZW5ndGgsIDEsXG4gICAgICAgICAgICBcIkhhcyB0aGUgY29ycmVjdCBudW1iZXIgb2YgcmVzdWx0cy5cIik7XG4gICAgICAgIHQuc2FtZShpbWFnZS5zaW1pbGFySW1hZ2VzWzBdLnRvSlNPTigpLFxuICAgICAgICAgICAge19pZDogXCJ0ZXN0L2Jhci5qcGdcIiwgc2NvcmU6IDEwfSxcbiAgICAgICAgICAgIFwiSGFzIHRoZSBjb3JyZWN0IHJlc3VsdC5cIik7XG4gICAgICAgIHQuZW5kKCk7XG4gICAgfSk7XG59KTtcblxudGFwLnRlc3QoXCJVcGxvYWRJbWFnZS5mcm9tRmlsZTogTmV3IFVwbG9hZEltYWdlXCIsICh0KSA9PiB7XG4gICAgY29uc3QgdGVzdEZpbGUgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgXCJ0ZXN0RGF0YVwiLCBcIm5ldzEuanBnXCIpO1xuXG4gICAgVXBsb2FkSW1hZ2UuZnJvbUZpbGUodGVzdEZpbGUsIChlcnIsIGltYWdlKSA9PiB7XG4gICAgICAgIHQuZXJyb3IoZXJyLCBcIk5vIGVycm9yIHNob3VsZCBiZSB0aHJvd24uXCIpO1xuICAgICAgICB0Lm9rKGltYWdlLCBcIlVwbG9hZEltYWdlIGV4aXN0cy5cIik7XG4gICAgICAgIC8vIFRPRE86IFRlc3QgdGhhdCBmaWxlcyBleGlzdC5cbiAgICAgICAgLy8gVGVzdCB0aGF0IGZpbGVzIGFyZSB0aGUgcmlnaHQgZGltZW5zaW9ucy5cbiAgICAgICAgdC5lbmQoKTtcbiAgICB9KTtcbn0pO1xuXG50YXAudGVzdChcIlVwbG9hZEltYWdlLmZyb21GaWxlOiBOZXcgVXBsb2FkSW1hZ2UgKEVtcHR5IEZpbGUpXCIsICh0KSA9PiB7XG4gICAgY29uc3QgdGVzdEZpbGUgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgXCJ0ZXN0RGF0YVwiLCBcImVtcHR5LmpwZ1wiKTtcblxuICAgIFVwbG9hZEltYWdlLmZyb21GaWxlKHRlc3RGaWxlLCAoZXJyLCBpbWFnZSkgPT4ge1xuICAgICAgICB0Lm9rKGVyciwgXCJIYXMgZXJyb3Igb2JqZWN0LlwiKTtcbiAgICAgICAgdC5lcXVhbChlcnIubWVzc2FnZSwgXCJFTVBUWV9JTUFHRVwiLCBcIkhhcyBlcnJvciBtZXNzYWdlLlwiKTtcbiAgICAgICAgdC5ub3RPayhpbWFnZSwgXCJObyBpbWFnZSBvYmplY3RcIik7XG4gICAgICAgIHQuZW5kKCk7XG4gICAgfSk7XG59KTtcblxudGFwLnRlc3QoXCJVcGxvYWRJbWFnZS5mcm9tRmlsZTogTmV3IFVwbG9hZEltYWdlIChDb3JydXB0ZWQgRmlsZSlcIiwgKHQpID0+IHtcbiAgICBjb25zdCB0ZXN0RmlsZSA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBcInRlc3REYXRhXCIsIFwiY29ycnVwdGVkLmpwZ1wiKTtcblxuICAgIFVwbG9hZEltYWdlLmZyb21GaWxlKHRlc3RGaWxlLCAoZXJyLCBpbWFnZSkgPT4ge1xuICAgICAgICB0Lm9rKGVyciwgXCJIYXMgZXJyb3Igb2JqZWN0LlwiKTtcbiAgICAgICAgdC5lcXVhbChlcnIubWVzc2FnZSwgXCJNQUxGT1JNRURfSU1BR0VcIiwgXCJIYXMgZXJyb3IgbWVzc2FnZS5cIik7XG4gICAgICAgIHQubm90T2soaW1hZ2UsIFwiTm8gaW1hZ2Ugb2JqZWN0XCIpO1xuICAgICAgICB0LmVuZCgpO1xuICAgIH0pO1xufSk7XG5cbnRhcC50ZXN0KFwiVXBsb2FkSW1hZ2UuZnJvbUZpbGU6IE5ldyBVcGxvYWRJbWFnZSAoU21hbGwgRmlsZSlcIiwgKHQpID0+IHtcbiAgICBjb25zdCB0ZXN0RmlsZSA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBcInRlc3REYXRhXCIsIFwic21hbGwuanBnXCIpO1xuXG4gICAgVXBsb2FkSW1hZ2UuZnJvbUZpbGUodGVzdEZpbGUsIChlcnIsIGltYWdlKSA9PiB7XG4gICAgICAgIHQub2soZXJyLCBcIkhhcyBlcnJvciBvYmplY3QuXCIpO1xuICAgICAgICB0LmVxdWFsKGVyci5tZXNzYWdlLCBcIlRPT19TTUFMTFwiLCBcIkhhcyBlcnJvciBtZXNzYWdlLlwiKTtcbiAgICAgICAgdC5ub3RPayhpbWFnZSwgXCJObyBpbWFnZSBvYmplY3RcIik7XG4gICAgICAgIHQuZW5kKCk7XG4gICAgfSk7XG59KTtcblxudGFwLnRlc3QoXCJVcGxvYWRJbWFnZS5mcm9tRmlsZTogVXBkYXRpbmcgVXBsb2FkSW1hZ2VcIiwgKHQpID0+IHtcbiAgICBjb25zdCB0ZXN0RmlsZSA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBcInRlc3REYXRhXCIsIFwiZm9vLmpwZ1wiKTtcblxuICAgIFVwbG9hZEltYWdlLmZyb21GaWxlKHRlc3RGaWxlLCAoZXJyLCBpbWFnZSkgPT4ge1xuICAgICAgICB0LmVycm9yKGVyciwgXCJObyBlcnJvciBzaG91bGQgYmUgdGhyb3duLlwiKTtcbiAgICAgICAgdC5vayhpbWFnZSwgXCJVcGxvYWRJbWFnZSBleGlzdHMuXCIpO1xuICAgICAgICB0LmVuZCgpO1xuICAgIH0pO1xufSk7XG5cbnRhcC50ZXN0KFwiVXBsb2FkSW1hZ2UuZnJvbUZpbGU6IFVwZGF0aW5nIChmaWxlcyBhbHJlYWR5IGV4aXN0KVwiLCAodCkgPT4ge1xuICAgIGNvbnN0IHRlc3RGaWxlID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIFwidGVzdERhdGFcIiwgXCJmb28uanBnXCIpO1xuXG4gICAgVXBsb2FkSW1hZ2UuZnJvbUZpbGUodGVzdEZpbGUsICgpID0+IHtcbiAgICAgICAgLy8gUnVuIHRoaXMgdHdpY2UgdG8gaGF2ZSB0aGUgaW1hZ2VzIGJlIHB1dCBpbnRvIHBsYWNlIGFscmVhZHlcbiAgICAgICAgVXBsb2FkSW1hZ2UuZnJvbUZpbGUodGVzdEZpbGUsIChlcnIsIGltYWdlKSA9PiB7XG4gICAgICAgICAgICB0LmVycm9yKGVyciwgXCJObyBlcnJvciBzaG91bGQgYmUgdGhyb3duLlwiKTtcbiAgICAgICAgICAgIHQub2soaW1hZ2UsIFwiVXBsb2FkSW1hZ2UgZXhpc3RzLlwiKTtcbiAgICAgICAgICAgIHQuZW5kKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7XG4iXX0=
"use strict";

var path = require("path");

var tap = require("tap");

var init = require("../init");
var Image = init.Image;
var ImageImport = init.ImageImport;

tap.test("getFilePath", { autoend: true }, function (t) {
    var image = init.getImage();
    t.equal(image.getFilePath(), path.resolve(process.cwd(), "data/test/images/4266906334.jpg"), "Check file path");
});

tap.test("getOriginalURL", { autoend: true }, function (t) {
    var image = init.getImage();
    t.equal(image.getOriginalURL(), "/data/test/images/4266906334.jpg", "Check Image URL");
});

tap.test("getScaledURL", { autoend: true }, function (t) {
    var image = init.getImage();
    t.equal(image.getScaledURL(), "/data/test/scaled/4266906334.jpg", "Check Scaled URL");
});

tap.test("getThumbURL", { autoend: true }, function (t) {
    var image = init.getImage();
    t.equal(image.getThumbURL(), "/data/test/thumbs/4266906334.jpg", "Check Thumb URL");
});

tap.test("getSource", { autoend: true }, function (t) {
    var image = init.getImage();
    var source = init.getSource();
    t.equal(image.getSource(), source, "Get Source");
});

tap.test("updateSimilarity: Existing Image", function (t) {
    var image = init.getImage();
    var oldSimilar = image.similarImages.slice(0);
    image.updateSimilarity(function (err) {
        t.error(err, "No error should be thrown.");
        t.notEqual(image.similarImages, oldSimilar, "Similarity updated.");
        t.equal(image.similarImages.length, 1, "Has the correct number of results.");
        t.same(image.similarImages[0].toJSON(), { _id: "test/bar.jpg", score: 10 }, "Has the correct result.");
        t.end();
    });
});

tap.test("updateSimilarity: Missing Image", function (t) {
    var image = new Image({
        _id: "test/foo",
        source: "test",
        fileName: "sadfasdfds.jpg",
        hash: "99999",
        width: 115,
        height: 115
    });

    var oldSimilar = image.similarImages;
    image.updateSimilarity(function (err) {
        t.error(err, "No error should be thrown.");
        t.equal(image.similarImages, oldSimilar, "Similarity not updated.");
        t.end();
    });
});

tap.test("indexSimilarity: Existing Image", function (t) {
    var image = init.getImage();
    image.indexSimilarity(function (err, indexed) {
        t.error(err, "No error should be thrown.");
        t.equal(indexed, true, "Image is indexed.");
        t.end();
    });
});

tap.test("indexSimilarity: Missing Image", function (t) {
    var image = new Image({
        _id: "test/foo",
        source: "test",
        fileName: "sadfasdfds.jpg",
        hash: "99999",
        width: 115,
        height: 115
    });

    image.indexSimilarity(function (err, indexed) {
        t.error(err, "No error should be thrown.");
        t.equal(indexed, true, "Image is indexed.");
        t.end();
    });
});

tap.test("indexSimilarity: Small Image", function (t) {
    var image = new Image({
        _id: "test/foo2",
        source: "test",
        fileName: "sadfasdfds2.jpg",
        hash: "99998",
        width: 90,
        height: 90
    });

    image.indexSimilarity(function (err, indexed) {
        t.error(err, "No error should be thrown.");
        t.equal(indexed, undefined, "Image is not indexed.");
        t.end();
    });
});

tap.test("Image.fromFile: New Image", function (t) {
    var batch = new ImageImport({
        _id: "testBatch",
        source: "test"
    });

    var testFile = path.resolve(process.cwd(), "testData", "new1.jpg");

    Image.fromFile(batch, testFile, function (err, image, warnings) {
        t.error(err, "No error should be thrown.");
        t.ok(image, "Image exists.");
        t.equal(warnings.length, 0, "No warnings.");
        // TODO: Test that files exist.
        // Test that files are the right dimensions.
        t.end();
    });
});

tap.test("Image.fromFile: New Image (Empty File)", function (t) {
    var batch = new ImageImport({
        _id: "testBatch",
        source: "test"
    });

    var testFile = path.resolve(process.cwd(), "testData", "empty.jpg");

    Image.fromFile(batch, testFile, function (err, image, warnings) {
        t.ok(err, "Has error object.");
        t.equal(err.message, "EMPTY_IMAGE", "Has error message.");
        t.notOk(image, "No image object");
        t.notOk(warnings, "No warnings object.");
        t.end();
    });
});

tap.test("Image.fromFile: New Image (Corrupted File)", function (t) {
    var batch = new ImageImport({
        _id: "testBatch",
        source: "test"
    });

    var testFile = path.resolve(process.cwd(), "testData", "corrupted.jpg");

    Image.fromFile(batch, testFile, function (err, image, warnings) {
        t.ok(err, "Has error object.");
        t.equal(err.message, "MALFORMED_IMAGE", "Has error message.");
        t.notOk(image, "No image object");
        t.notOk(warnings, "No warnings object.");
        t.end();
    });
});

tap.test("Image.fromFile: New Image (Small File)", function (t) {
    var batch = new ImageImport({
        _id: "testBatch",
        source: "test"
    });

    var testFile = path.resolve(process.cwd(), "testData", "test-small.jpg");

    Image.fromFile(batch, testFile, function (err, image, warnings) {
        t.error(err, "No error should be thrown.");
        t.ok(image, "Image exists.");
        t.same(warnings, ["TOO_SMALL"], "One warning.");
        t.end();
    });
});

tap.test("Image.fromFile: Updating Image", function (t) {
    var batch = new ImageImport({
        _id: "testBatch",
        source: "test"
    });

    var testFile = path.resolve(process.cwd(), "testData", "nosimilar.jpg");

    Image.fromFile(batch, testFile, function (err, image, warnings) {
        t.error(err, "No error should be thrown.");
        t.ok(image, "Image exists.");
        t.same(warnings, ["NEW_VERSION"], "One warning.");
        t.end();
    });
});

tap.test("Image.fromFile: Updating Image (files already exist)", function (t) {
    var batch = new ImageImport({
        _id: "testBatch",
        source: "test"
    });

    var testFile = path.resolve(process.cwd(), "testData", "foo.jpg");

    Image.fromFile(batch, testFile, function () {
        // Run this twice to have the images be put into place already
        Image.fromFile(batch, testFile, function (err, image, warnings) {
            t.error(err, "No error should be thrown.");
            t.ok(image, "Image exists.");
            t.equal(warnings.length, 0, "No warnings.");
            t.end();
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90ZXN0cy9zY2hlbWFzL0ltYWdlLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwidGFwIiwiaW5pdCIsIkltYWdlIiwiSW1hZ2VJbXBvcnQiLCJ0ZXN0IiwiYXV0b2VuZCIsInQiLCJpbWFnZSIsImdldEltYWdlIiwiZXF1YWwiLCJnZXRGaWxlUGF0aCIsInJlc29sdmUiLCJwcm9jZXNzIiwiY3dkIiwiZ2V0T3JpZ2luYWxVUkwiLCJnZXRTY2FsZWRVUkwiLCJnZXRUaHVtYlVSTCIsInNvdXJjZSIsImdldFNvdXJjZSIsIm9sZFNpbWlsYXIiLCJzaW1pbGFySW1hZ2VzIiwic2xpY2UiLCJ1cGRhdGVTaW1pbGFyaXR5IiwiZXJyIiwiZXJyb3IiLCJub3RFcXVhbCIsImxlbmd0aCIsInNhbWUiLCJ0b0pTT04iLCJfaWQiLCJzY29yZSIsImVuZCIsImZpbGVOYW1lIiwiaGFzaCIsIndpZHRoIiwiaGVpZ2h0IiwiaW5kZXhTaW1pbGFyaXR5IiwiaW5kZXhlZCIsInVuZGVmaW5lZCIsImJhdGNoIiwidGVzdEZpbGUiLCJmcm9tRmlsZSIsIndhcm5pbmdzIiwib2siLCJtZXNzYWdlIiwibm90T2siXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsT0FBT0MsUUFBUSxNQUFSLENBQWI7O0FBRUEsSUFBTUMsTUFBTUQsUUFBUSxLQUFSLENBQVo7O0FBRUEsSUFBTUUsT0FBT0YsUUFBUSxTQUFSLENBQWI7QUFDQSxJQUFNRyxRQUFRRCxLQUFLQyxLQUFuQjtBQUNBLElBQU1DLGNBQWNGLEtBQUtFLFdBQXpCOztBQUVBSCxJQUFJSSxJQUFKLENBQVMsYUFBVCxFQUF3QixFQUFDQyxTQUFTLElBQVYsRUFBeEIsRUFBeUMsVUFBQ0MsQ0FBRCxFQUFPO0FBQzVDLFFBQU1DLFFBQVFOLEtBQUtPLFFBQUwsRUFBZDtBQUNBRixNQUFFRyxLQUFGLENBQVFGLE1BQU1HLFdBQU4sRUFBUixFQUNJWixLQUFLYSxPQUFMLENBQWFDLFFBQVFDLEdBQVIs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O0FBZ0JBL0IsSUFBSUksSUFBSixDQUFTLHNEQUFULEVBQWlFLFVBQUNFLENBQUQsRUFBTztBQUNwRSxRQUFNaUMsUUFBUSxJQUFJcEMsV0FBSixDQUFnQjtBQUMxQjBCLGFBQUssV0FEcUI7QUFFMUJaLGdCQUFRO0FBRmtCLEtBQWhCLENBQWQ7O0FBS0EsUUFBTXVCLFdBQVcxQyxLQUFLYSxPQUFMLENBQWFDLFFBQVFDLEdBQVIsRUFBYixFQUE0QixVQUE1QixFQUF3QyxTQUF4QyxDQUFqQjs7QUFFQVgsVUFBTXVDLFFBQU4sQ0FBZUYsS0FBZixFQUFzQkMsUUFBdEIsRUFBZ0MsWUFBTTtBQUNsQztBQUNBdEMsY0FBTXVDLFFBQU4sQ0FBZUYsS0FBZixFQUFzQkMsUUFBdEIsRUFBZ0MsVUFBQ2pCLEdBQUQsRUFBTWhCLEtBQU4sRUFBYW1DLFFBQWIsRUFBMEI7QUFDdERwQyxjQUFFa0IsS0FBRixDQUFRRCxHQUFSLEVBQWEsNEJBQWI7QUFDQWpCLGNBQUVxQyxFQUFGLENBQUtwQyxLQUFMLEVBQVksZUFBWjtBQUNBRCxjQUFFRyxLQUFGLENBQVFpQyxTQUFTaEIsTUFBakIsRUFBeUIsQ0FBekIsRUFBNEIsY0FBNUI7QUFDQXBCLGNBQUV5QixHQUFGO0FBQ0gsU0FMRDtBQU1ILEtBUkQ7QUFTSCxDQWpCRCIsImZpbGUiOiJJbWFnZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcblxuY29uc3QgdGFwID0gcmVxdWlyZShcInRhcFwiKTtcblxuY29uc3QgaW5pdCA9IHJlcXVpcmUoXCIuLi9pbml0XCIpO1xuY29uc3QgSW1hZ2UgPSBpbml0LkltYWdlO1xuY29uc3QgSW1hZ2VJbXBvcnQgPSBpbml0LkltYWdlSW1wb3J0O1xuXG50YXAudGVzdChcImdldEZpbGVQYXRoXCIsIHthdXRvZW5kOiB0cnVlfSwgKHQpID0+IHtcbiAgICBjb25zdCBpbWFnZSA9IGluaXQuZ2V0SW1hZ2UoKTtcbiAgICB0LmVxdWFsKGltYWdlLmdldEZpbGVQYXRoKCksXG4gICAgICAgIHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBcImRhdGEvdGVzdC9pbWFnZXMvNDI2NjkwNjMzNC5qcGdcIiksXG4gICAgICAgIFwiQ2hlY2sgZmlsZSBwYXRoXCIpO1xufSk7XG5cbnRhcC50ZXN0KFwiZ2V0T3JpZ2luYWxVUkxcIiwge2F1dG9lbmQ6IHRydWV9LCAodCkgPT4ge1xuICAgIGNvbnN0IGltYWdlID0gaW5pdC5nZXRJbWFnZSgpO1xuICAgIHQuZXF1YWwoaW1hZ2UuZ2V0T3JpZ2luYWxVUkwoKSxcbiAgICAgICAgXCIvZGF0YS90ZXN0L2ltYWdlcy80MjY2OTA2MzM0LmpwZ1wiLCBcIkNoZWNrIEltYWdlIFVSTFwiKTtcbn0pO1xuXG50YXAudGVzdChcImdldFNjYWxlZFVSTFwiLCB7YXV0b2VuZDogdHJ1ZX0sICh0KSA9PiB7XG4gICAgY29uc3QgaW1hZ2UgPSBpbml0LmdldEltYWdlKCk7XG4gICAgdC5lcXVhbChpbWFnZS5nZXRTY2FsZWRVUkwoKSxcbiAgICAgICAgXCIvZGF0YS90ZXN0L3NjYWxlZC80MjY2OTA2MzM0LmpwZ1wiLCBcIkNoZWNrIFNjYWxlZCBVUkxcIik7XG59KTtcblxudGFwLnRlc3QoXCJnZXRUaHVtYlVSTFwiLCB7YXV0b2VuZDogdHJ1ZX0sICh0KSA9PiB7XG4gICAgY29uc3QgaW1hZ2UgPSBpbml0LmdldEltYWdlKCk7XG4gICAgdC5lcXVhbChpbWFnZS5nZXRUaHVtYlVSTCgpLFxuICAgICAgICBcIi9kYXRhL3Rlc3QvdGh1bWJzLzQyNjY5MDYzMzQuanBnXCIsIFwiQ2hlY2sgVGh1bWIgVVJMXCIpO1xufSk7XG5cbnRhcC50ZXN0KFwiZ2V0U291cmNlXCIsIHthdXRvZW5kOiB0cnVlfSwgKHQpID0+IHtcbiAgICBjb25zdCBpbWFnZSA9IGluaXQuZ2V0SW1hZ2UoKTtcbiAgICBjb25zdCBzb3VyY2UgPSBpbml0LmdldFNvdXJjZSgpO1xuICAgIHQuZXF1YWwoaW1hZ2UuZ2V0U291cmNlKCksIHNvdXJjZSwgXCJHZXQgU291cmNlXCIpO1xufSk7XG5cbnRhcC50ZXN0KFwidXBkYXRlU2ltaWxhcml0eTogRXhpc3RpbmcgSW1hZ2VcIiwgKHQpID0+IHtcbiAgICBjb25zdCBpbWFnZSA9IGluaXQuZ2V0SW1hZ2UoKTtcbiAgICBjb25zdCBvbGRTaW1pbGFyID0gaW1hZ2Uuc2ltaWxhckltYWdlcy5zbGljZSgwKTtcbiAgICBpbWFnZS51cGRhdGVTaW1pbGFyaXR5KChlcnIpID0+IHtcbiAgICAgICAgdC5lcnJvcihlcnIsIFwiTm8gZXJyb3Igc2hvdWxkIGJlIHRocm93bi5cIik7XG4gICAgICAgIHQubm90RXF1YWwoaW1hZ2Uuc2ltaWxhckltYWdlcywgb2xkU2ltaWxhciwgXCJTaW1pbGFyaXR5IHVwZGF0ZWQuXCIpO1xuICAgICAgICB0LmVxdWFsKGltYWdlLnNpbWlsYXJJbWFnZXMubGVuZ3RoLCAxLFxuICAgICAgICAgICAgXCJIYXMgdGhlIGNvcnJlY3QgbnVtYmVyIG9mIHJlc3VsdHMuXCIpO1xuICAgICAgICB0LnNhbWUoaW1hZ2Uuc2ltaWxhckltYWdlc1swXS50b0pTT04oKSxcbiAgICAgICAgICAgIHtfaWQ6IFwidGVzdC9iYXIuanBnXCIsIHNjb3JlOiAxMH0sXG4gICAgICAgICAgICBcIkhhcyB0aGUgY29ycmVjdCByZXN1bHQuXCIpO1xuICAgICAgICB0LmVuZCgpO1xuICAgIH0pO1xufSk7XG5cbnRhcC50ZXN0KFwidXBkYXRlU2ltaWxhcml0eTogTWlzc2luZyBJbWFnZVwiLCAodCkgPT4ge1xuICAgIGNvbnN0IGltYWdlID0gbmV3IEltYWdlKHtcbiAgICAgICAgX2lkOiBcInRlc3QvZm9vXCIsXG4gICAgICAgIHNvdXJjZTogXCJ0ZXN0XCIsXG4gICAgICAgIGZpbGVOYW1lOiBcInNhZGZhc2RmZHMuanBnXCIsXG4gICAgICAgIGhhc2g6IFwiOTk5OTlcIixcbiAgICAgICAgd2lkdGg6IDExNSxcbiAgICAgICAgaGVpZ2h0OiAxMTUsXG4gICAgfSk7XG5cbiAgICBjb25zdCBvbGRTaW1pbGFyID0gaW1hZ2Uuc2ltaWxhckltYWdlcztcbiAgICBpbWFnZS51cGRhdGVTaW1pbGFyaXR5KChlcnIpID0+IHtcbiAgICAgICAgdC5lcnJvcihlcnIsIFwiTm8gZXJyb3Igc2hvdWxkIGJlIHRocm93bi5cIik7XG4gICAgICAgIHQuZXF1YWwoaW1hZ2Uuc2ltaWxhckltYWdlcywgb2xkU2ltaWxhciwgXCJTaW1pbGFyaXR5IG5vdCB1cGRhdGVkLlwiKTtcbiAgICAgICAgdC5lbmQoKTtcbiAgICB9KTtcbn0pO1xuXG50YXAudGVzdChcImluZGV4U2ltaWxhcml0eTogRXhpc3RpbmcgSW1hZ2VcIiwgKHQpID0+IHtcbiAgICBjb25zdCBpbWFnZSA9IGluaXQuZ2V0SW1hZ2UoKTtcbiAgICBpbWFnZS5pbmRleFNpbWlsYXJpdHkoKGVyciwgaW5kZXhlZCkgPT4ge1xuICAgICAgICB0LmVycm9yKGVyciwgXCJObyBlcnJvciBzaG91bGQgYmUgdGhyb3duLlwiKTtcbiAgICAgICAgdC5lcXVhbChpbmRleGVkLCB0cnVlLCBcIkltYWdlIGlzIGluZGV4ZWQuXCIpO1xuICAgICAgICB0LmVuZCgpO1xuICAgIH0pO1xufSk7XG5cbnRhcC50ZXN0KFwiaW5kZXhTaW1pbGFyaXR5OiBNaXNzaW5nIEltYWdlXCIsICh0KSA9PiB7XG4gICAgY29uc3QgaW1hZ2UgPSBuZXcgSW1hZ2Uoe1xuICAgICAgICBfaWQ6IFwidGVzdC9mb29cIixcbiAgICAgICAgc291cmNlOiBcInRlc3RcIixcbiAgICAgICAgZmlsZU5hbWU6IFwic2FkZmFzZGZkcy5qcGdcIixcbiAgICAgICAgaGFzaDogXCI5OTk5OVwiLFxuICAgICAgICB3aWR0aDogMTE1LFxuICAgICAgICBoZWlnaHQ6IDExNSxcbiAgICB9KTtcblxuICAgIGltYWdlLmluZGV4U2ltaWxhcml0eSgoZXJyLCBpbmRleGVkKSA9PiB7XG4gICAgICAgIHQuZXJyb3IoZXJyLCBcIk5vIGVycm9yIHNob3VsZCBiZSB0aHJvd24uXCIpO1xuICAgICAgICB0LmVxdWFsKGluZGV4ZWQsIHRydWUsIFwiSW1hZ2UgaXMgaW5kZXhlZC5cIik7XG4gICAgICAgIHQuZW5kKCk7XG4gICAgfSk7XG59KTtcblxudGFwLnRlc3QoXCJpbmRleFNpbWlsYXJpdHk6IFNtYWxsIEltYWdlXCIsICh0KSA9PiB7XG4gICAgY29uc3QgaW1hZ2UgPSBuZXcgSW1hZ2Uoe1xuICAgICAgICBfaWQ6IFwidGVzdC9mb28yXCIsXG4gICAgICAgIHNvdXJjZTogXCJ0ZXN0XCIsXG4gICAgICAgIGZpbGVOYW1lOiBcInNhZGZhc2RmZHMyLmpwZ1wiLFxuICAgICAgICBoYXNoOiBcIjk5OTk4XCIsXG4gICAgICAgIHdpZHRoOiA5MCxcbiAgICAgICAgaGVpZ2h0OiA5MCxcbiAgICB9KTtcblxuICAgIGltYWdlLmluZGV4U2ltaWxhcml0eSgoZXJyLCBpbmRleGVkKSA9PiB7XG4gICAgICAgIHQuZXJyb3IoZXJyLCBcIk5vIGVycm9yIHNob3VsZCBiZSB0aHJvd24uXCIpO1xuICAgICAgICB0LmVxdWFsKGluZGV4ZWQsIHVuZGVmaW5lZCwgXCJJbWFnZSBpcyBub3QgaW5kZXhlZC5cIik7XG4gICAgICAgIHQuZW5kKCk7XG4gICAgfSk7XG59KTtcblxudGFwLnRlc3QoXCJJbWFnZS5mcm9tRmlsZTogTmV3IEltYWdlXCIsICh0KSA9PiB7XG4gICAgY29uc3QgYmF0Y2ggPSBuZXcgSW1hZ2VJbXBvcnQoe1xuICAgICAgICBfaWQ6IFwidGVzdEJhdGNoXCIsXG4gICAgICAgIHNvdXJjZTogXCJ0ZXN0XCIsXG4gICAgfSk7XG5cbiAgICBjb25zdCB0ZXN0RmlsZSA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBcInRlc3REYXRhXCIsIFwibmV3MS5qcGdcIik7XG5cbiAgICBJbWFnZS5mcm9tRmlsZShiYXRjaCwgdGVzdEZpbGUsIChlcnIsIGltYWdlLCB3YXJuaW5ncykgPT4ge1xuICAgICAgICB0LmVycm9yKGVyciwgXCJObyBlcnJvciBzaG91bGQgYmUgdGhyb3duLlwiKTtcbiAgICAgICAgdC5vayhpbWFnZSwgXCJJbWFnZSBleGlzdHMuXCIpO1xuICAgICAgICB0LmVxdWFsKHdhcm5pbmdzLmxlbmd0aCwgMCwgXCJObyB3YXJuaW5ncy5cIik7XG4gICAgICAgIC8vIFRPRE86IFRlc3QgdGhhdCBmaWxlcyBleGlzdC5cbiAgICAgICAgLy8gVGVzdCB0aGF0IGZpbGVzIGFyZSB0aGUgcmlnaHQgZGltZW5zaW9ucy5cbiAgICAgICAgdC5lbmQoKTtcbiAgICB9KTtcbn0pO1xuXG50YXAudGVzdChcIkltYWdlLmZyb21GaWxlOiBOZXcgSW1hZ2UgKEVtcHR5IEZpbGUpXCIsICh0KSA9PiB7XG4gICAgY29uc3QgYmF0Y2ggPSBuZXcgSW1hZ2VJbXBvcnQoe1xuICAgICAgICBfaWQ6IFwidGVzdEJhdGNoXCIsXG4gICAgICAgIHNvdXJjZTogXCJ0ZXN0XCIsXG4gICAgfSk7XG5cbiAgICBjb25zdCB0ZXN0RmlsZSA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBcInRlc3REYXRhXCIsIFwiZW1wdHkuanBnXCIpO1xuXG4gICAgSW1hZ2UuZnJvbUZpbGUoYmF0Y2gsIHRlc3RGaWxlLCAoZXJyLCBpbWFnZSwgd2FybmluZ3MpID0+IHtcbiAgICAgICAgdC5vayhlcnIsIFwiSGFzIGVycm9yIG9iamVjdC5cIik7XG4gICAgICAgIHQuZXF1YWwoZXJyLm1lc3NhZ2UsIFwiRU1QVFlfSU1BR0VcIiwgXCJIYXMgZXJyb3IgbWVzc2FnZS5cIik7XG4gICAgICAgIHQubm90T2soaW1hZ2UsIFwiTm8gaW1hZ2Ugb2JqZWN0XCIpO1xuICAgICAgICB0Lm5vdE9rKHdhcm5pbmdzLCBcIk5vIHdhcm5pbmdzIG9iamVjdC5cIik7XG4gICAgICAgIHQuZW5kKCk7XG4gICAgfSk7XG59KTtcblxudGFwLnRlc3QoXCJJbWFnZS5mcm9tRmlsZTogTmV3IEltYWdlIChDb3JydXB0ZWQgRmlsZSlcIiwgKHQpID0+IHtcbiAgICBjb25zdCBiYXRjaCA9IG5ldyBJbWFnZUltcG9ydCh7XG4gICAgICAgIF9pZDogXCJ0ZXN0QmF0Y2hcIixcbiAgICAgICAgc291cmNlOiBcInRlc3RcIixcbiAgICB9KTtcblxuICAgIGNvbnN0IHRlc3RGaWxlID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIFwidGVzdERhdGFcIiwgXCJjb3JydXB0ZWQuanBnXCIpO1xuXG4gICAgSW1hZ2UuZnJvbUZpbGUoYmF0Y2gsIHRlc3RGaWxlLCAoZXJyLCBpbWFnZSwgd2FybmluZ3MpID0+IHtcbiAgICAgICAgdC5vayhlcnIsIFwiSGFzIGVycm9yIG9iamVjdC5cIik7XG4gICAgICAgIHQuZXF1YWwoZXJyLm1lc3NhZ2UsIFwiTUFMRk9STUVEX0lNQUdFXCIsIFwiSGFzIGVycm9yIG1lc3NhZ2UuXCIpO1xuICAgICAgICB0Lm5vdE9rKGltYWdlLCBcIk5vIGltYWdlIG9iamVjdFwiKTtcbiAgICAgICAgdC5ub3RPayh3YXJuaW5ncywgXCJObyB3YXJuaW5ncyBvYmplY3QuXCIpO1xuICAgICAgICB0LmVuZCgpO1xuICAgIH0pO1xufSk7XG5cbnRhcC50ZXN0KFwiSW1hZ2UuZnJvbUZpbGU6IE5ldyBJbWFnZSAoU21hbGwgRmlsZSlcIiwgKHQpID0+IHtcbiAgICBjb25zdCBiYXRjaCA9IG5ldyBJbWFnZUltcG9ydCh7XG4gICAgICAgIF9pZDogXCJ0ZXN0QmF0Y2hcIixcbiAgICAgICAgc291cmNlOiBcInRlc3RcIixcbiAgICB9KTtcblxuICAgIGNvbnN0IHRlc3RGaWxlID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIFwidGVzdERhdGFcIiwgXCJ0ZXN0LXNtYWxsLmpwZ1wiKTtcblxuICAgIEltYWdlLmZyb21GaWxlKGJhdGNoLCB0ZXN0RmlsZSwgKGVyciwgaW1hZ2UsIHdhcm5pbmdzKSA9PiB7XG4gICAgICAgIHQuZXJyb3IoZXJyLCBcIk5vIGVycm9yIHNob3VsZCBiZSB0aHJvd24uXCIpO1xuICAgICAgICB0Lm9rKGltYWdlLCBcIkltYWdlIGV4aXN0cy5cIik7XG4gICAgICAgIHQuc2FtZSh3YXJuaW5ncywgW1wiVE9PX1NNQUxMXCJdLCBcIk9uZSB3YXJuaW5nLlwiKTtcbiAgICAgICAgdC5lbmQoKTtcbiAgICB9KTtcbn0pO1xuXG50YXAudGVzdChcIkltYWdlLmZyb21GaWxlOiBVcGRhdGluZyBJbWFnZVwiLCAodCkgPT4ge1xuICAgIGNvbnN0IGJhdGNoID0gbmV3IEltYWdlSW1wb3J0KHtcbiAgICAgICAgX2lkOiBcInRlc3RCYXRjaFwiLFxuICAgICAgICBzb3VyY2U6IFwidGVzdFwiLFxuICAgIH0pO1xuXG4gICAgY29uc3QgdGVzdEZpbGUgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgXCJ0ZXN0RGF0YVwiLCBcIm5vc2ltaWxhci5qcGdcIik7XG5cbiAgICBJbWFnZS5mcm9tRmlsZShiYXRjaCwgdGVzdEZpbGUsIChlcnIsIGltYWdlLCB3YXJuaW5ncykgPT4ge1xuICAgICAgICB0LmVycm9yKGVyciwgXCJObyBlcnJvciBzaG91bGQgYmUgdGhyb3duLlwiKTtcbiAgICAgICAgdC5vayhpbWFnZSwgXCJJbWFnZSBleGlzdHMuXCIpO1xuICAgICAgICB0LnNhbWUod2FybmluZ3MsIFtcIk5FV19WRVJTSU9OXCJdLCBcIk9uZSB3YXJuaW5nLlwiKTtcbiAgICAgICAgdC5lbmQoKTtcbiAgICB9KTtcbn0pO1xuXG50YXAudGVzdChcIkltYWdlLmZyb21GaWxlOiBVcGRhdGluZyBJbWFnZSAoZmlsZXMgYWxyZWFkeSBleGlzdClcIiwgKHQpID0+IHtcbiAgICBjb25zdCBiYXRjaCA9IG5ldyBJbWFnZUltcG9ydCh7XG4gICAgICAgIF9pZDogXCJ0ZXN0QmF0Y2hcIixcbiAgICAgICAgc291cmNlOiBcInRlc3RcIixcbiAgICB9KTtcblxuICAgIGNvbnN0IHRlc3RGaWxlID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIFwidGVzdERhdGFcIiwgXCJmb28uanBnXCIpO1xuXG4gICAgSW1hZ2UuZnJvbUZpbGUoYmF0Y2gsIHRlc3RGaWxlLCAoKSA9PiB7XG4gICAgICAgIC8vIFJ1biB0aGlzIHR3aWNlIHRvIGhhdmUgdGhlIGltYWdlcyBiZSBwdXQgaW50byBwbGFjZSBhbHJlYWR5XG4gICAgICAgIEltYWdlLmZyb21GaWxlKGJhdGNoLCB0ZXN0RmlsZSwgKGVyciwgaW1hZ2UsIHdhcm5pbmdzKSA9PiB7XG4gICAgICAgICAgICB0LmVycm9yKGVyciwgXCJObyBlcnJvciBzaG91bGQgYmUgdGhyb3duLlwiKTtcbiAgICAgICAgICAgIHQub2soaW1hZ2UsIFwiSW1hZ2UgZXhpc3RzLlwiKTtcbiAgICAgICAgICAgIHQuZXF1YWwod2FybmluZ3MubGVuZ3RoLCAwLCBcIk5vIHdhcm5pbmdzLlwiKTtcbiAgICAgICAgICAgIHQuZW5kKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7XG4iXX0=
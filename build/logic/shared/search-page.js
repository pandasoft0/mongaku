"use strict";

var record = require("../../lib/record");

var search = require("./search");

module.exports = function (req, res, next, tmplParams) {
    var fields = Object.assign({}, req.query, req.params);

    search(fields, req, function (err, data, expectedURL) {
        if (err) {
            return next(new Error(req.gettext("Error connecting to database.")));
        }

        if (expectedURL) {
            return res.redirect(expectedURL);
        }

        if (data.values.format === "json") {
            return res.status(200).send(data);
        }

        var type = req.params.type;
        var Record = record(type);
        Record.getFacets(req, function (err, globalFacets) {
            var tmplData = Object.assign(data, tmplParams, {
                globalFacets: globalFacets
            });
            res.render("Search", tmplData);
        });
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sb2dpYy9zaGFyZWQvc2VhcmNoLXBhZ2UuanMiXSwibmFtZXMiOlsicmVjb3JkIiwicmVxdWlyZSIsInNlYXJjaCIsIm1vZHVsZSIsImV4cG9ydHMiLCJyZXEiLCJyZXMiLCJuZXh0IiwidG1wbFBhcmFtcyIsImZpZWxkcyIsIk9iamVjdCIsImFzc2lnbiIsInF1ZXJ5IiwicGFyYW1zIiwiZXJyIiwiZGF0YSIsImV4cGVjdGVkVVJMIiwiRXJyb3IiLCJnZXR0ZXh0IiwicmVkaXJlY3QiLCJ2YWx1ZXMiLCJmb3JtYXQiLCJzdGF0dXMiLCJzZW5kIiwidHlwZSIsIlJlY29yZCIsImdldEZhY2V0cyIsImdsb2JhbEZhY2V0cyIsInRtcGxEYXRhIiwicmVuZGVyIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQU1BLFNBQVNDLFFBQVEsa0JBQVIsQ0FBZjs7QUFFQSxJQUFNQyxTQUFTRCxRQUFRLFVBQVIsQ0FBZjs7QUFFQUUsT0FBT0MsT0FBUCxHQUFpQixVQUFDQyxHQUFELEVBQU1DLEdBQU4sRUFBV0MsSUFBWCxFQUFpQkMsVUFBakIsRUFBZ0M7QUFDN0MsUUFBTUMsU0FBU0MsT0FBT0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JOLElBQUlPLEtBQXRCLEVBQTZCUCxJQUFJUSxNQUFqQyxDQUFmOztBQUVBWCxXQUFPTyxNQUFQLEVBQWVKLEdBQWYsRUFBb0IsVUFBQ1MsR0FBRCxFQUFNQyxJQUFOLEVBQVlDLFdBQVosRUFBNEI7QUFDNUMsWUFBSUYsR0FBSixFQUFTO0FBQ0wsbUJBQU9QLEtBQUssSUFBSVUsS0FBSixDQUNSWixJQUFJYSxPQUFKLENBQVksK0JBQVosQ0FEUSxDQUFMLENBQVA7QUFFSDs7QUFFRCxZQUFJRixXQUFKLEVBQWlCO0FBQ2IsbUJBQU9WLElBQUlhLFFBQUosQ0FBYUgsV0FBYixDQUFQO0FBQ0g7O0FBRUQsWUFBSUQsS0FBS0ssTUFBTCxDQUFZQyxNQUFaLEtBQXVCLE1BQTNCLEVBQW1DO0FBQy9CLG1CQUFPZixJQUFJZ0IsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCUixJQUFyQixDQUFQO0FBQ0g7O0FBRUQsWUFBTVMsT0FBT25CLElBQUlRLE1BQUosQ0FBV1csSUFBeEI7QUFDQSxZQUFNQyxTQUFTekIsT0FBT3dCLElBQVAsQ0FBZjtBQUNBQyxlQUFPQyxTQUFQLENBQWlCckIsR0FBakIsRUFBc0IsVUFBQ1MsR0FBRCxFQUFNYSxZQUFOLEVBQXVCO0FBQ3pDLGdCQUFNQyxXQUFXbEIsT0FBT0MsTUFBUCxDQUFjSSxJQUFkLEVBQW9CUCxVQUFwQixFQUFnQztBQUM3Q21CO0FBRDZDLGFBQWhDLENBQWpCO0FBR0FyQixnQkFBSXVCLE1BQUosQ0FBVyxRQUFYLEVBQXFCRCxRQUFyQjtBQUNILFNBTEQ7QUFNSCxLQXRCRDtBQXVCSCxDQTFCRCIsImZpbGUiOiJzZWFyY2gtcGFnZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHJlY29yZCA9IHJlcXVpcmUoXCIuLi8uLi9saWIvcmVjb3JkXCIpO1xuXG5jb25zdCBzZWFyY2ggPSByZXF1aXJlKFwiLi9zZWFyY2hcIik7XG5cbm1vZHVsZS5leHBvcnRzID0gKHJlcSwgcmVzLCBuZXh0LCB0bXBsUGFyYW1zKSA9PiB7XG4gICAgY29uc3QgZmllbGRzID0gT2JqZWN0LmFzc2lnbih7fSwgcmVxLnF1ZXJ5LCByZXEucGFyYW1zKTtcblxuICAgIHNlYXJjaChmaWVsZHMsIHJlcSwgKGVyciwgZGF0YSwgZXhwZWN0ZWRVUkwpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQobmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIHJlcS5nZXR0ZXh0KFwiRXJyb3IgY29ubmVjdGluZyB0byBkYXRhYmFzZS5cIikpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChleHBlY3RlZFVSTCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlcy5yZWRpcmVjdChleHBlY3RlZFVSTCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGF0YS52YWx1ZXMuZm9ybWF0ID09PSBcImpzb25cIikge1xuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5zZW5kKGRhdGEpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdHlwZSA9IHJlcS5wYXJhbXMudHlwZTtcbiAgICAgICAgY29uc3QgUmVjb3JkID0gcmVjb3JkKHR5cGUpO1xuICAgICAgICBSZWNvcmQuZ2V0RmFjZXRzKHJlcSwgKGVyciwgZ2xvYmFsRmFjZXRzKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0bXBsRGF0YSA9IE9iamVjdC5hc3NpZ24oZGF0YSwgdG1wbFBhcmFtcywge1xuICAgICAgICAgICAgICAgIGdsb2JhbEZhY2V0cyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmVzLnJlbmRlcihcIlNlYXJjaFwiLCB0bXBsRGF0YSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufTtcbiJdfQ==